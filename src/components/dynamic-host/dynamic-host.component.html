
<div class="w-full h-full p-2 rounded-lg flex items-center justify-center overflow-hidden transition-all duration-100 relative"
     [class.border-slate-300]="!isPreviewMode() && !isSelected()"
     [class.border-dashed]="!isPreviewMode() && !isSelected()"
     [class.border]="!isPreviewMode() && !isSelected()"
     [class.hover:border-blue-500]="!isPreviewMode() && !instance().ui?.locked"
     [class.border-blue-600]="isSelected() && !isPreviewMode()"
     [class.border-solid]="isSelected() && !isPreviewMode()"
     [class.border-2]="(instance().ui?.semiStroke && !isPreviewMode()) || (isSelected() && !isPreviewMode())"
     [class.ring-2]="isSelected() && !isPreviewMode()"
     [class.ring-blue-500]="isSelected() && !isPreviewMode()"
     [class.ring-offset-2]="isSelected() && !isPreviewMode()"
     [class.border-blue-500]="instance().ui?.semiStroke && !isPreviewMode()">
  
  @if(instance().ui?.locked && !isPreviewMode()) {
    <div class="absolute top-1 left-1 bg-slate-700 text-white rounded-full p-1 z-20">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    </div>
  }

  <div class="w-full h-full" [class.pointer-events-auto]="isPreviewMode()">
    <ng-container *ngComponentOutlet="componentType(); inputs: { instance: instance() }"></ng-container>
  </div>
</div>

@if (!isPreviewMode() && !instance().ui?.locked) {
  <div class="absolute -top-2 -right-2 flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-20 js-no-drag">
    <button 
      (click)="onEditClick($event)"
      class="w-6 h-6 bg-slate-600 text-white rounded-full flex items-center justify-center transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-slate-700 focus:ring-offset-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
    <button 
      (click)="onRemoveClick($event)"
      class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <!-- Resize Handles -->
  <div class="absolute bottom-[-2px] right-[-2px] w-3 h-3 cursor-nwse-resize opacity-0 group-hover:opacity-100 z-20 js-no-drag" (mousedown)="onResizeStart($event, 'se')"></div>
  <div class="absolute bottom-[-2px] left-[-2px] w-3 h-3 cursor-nesw-resize opacity-0 group-hover:opacity-100 z-20 js-no-drag" (mousedown)="onResizeStart($event, 'sw')"></div>
  <div class="absolute top-[-2px] left-[-2px] w-3 h-3 cursor-nwse-resize opacity-0 group-hover:opacity-100 z-20 js-no-drag" (mousedown)="onResizeStart($event, 'nw')"></div>
  <div class="absolute top-[-2px] right-[-2px] w-3 h-3 cursor-nesw-resize opacity-0 group-hover:opacity-100 z-20 js-no-drag" (mousedown)="onResizeStart($event, 'ne')"></div>
}

<!-- Context Menu -->
@if (contextMenu(); as cm) {
  <div class="fixed bg-white rounded-md shadow-lg border border-slate-200 py-1 z-50 text-sm pointer-events-auto"
       [style.left.px]="cm.x"
       [style.top.px]="cm.y">
    <ul>
      <li (click)="toggleSemiStroke($event)" class="px-4 py-1.5 hover:bg-slate-100 cursor-pointer">
        Toggle Semi Stroke
      </li>
      <li (click)="toggleLock($event)" class="px-4 py-1.5 hover:bg-slate-100 cursor-pointer">
        {{ instance().ui?.locked ? 'Unlock Widget' : 'Lock Widget' }}
      </li>
      @if(instance().type === 'container' && instance().children?.length) {
        <li (click)="onUngroup($event)" class="px-4 py-1.5 hover:bg-slate-100 cursor-pointer">
          Ungroup
        </li>
      }
    </ul>
  </div>
}
