
<div class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
  <div class="w-full max-w-7xl h-[80vh] bg-white rounded-2xl shadow-2xl flex overflow-hidden border border-slate-200">
    
    <!-- Pages Sidebar -->
    @if (!isPreviewMode()) {
      <aside class="w-48 bg-slate-800 text-slate-200 p-3 flex flex-col">
        <h2 class="text-sm font-semibold text-slate-400 mb-3 px-2">Pages</h2>
        <ul class="space-y-1 flex-1">
          @for(page of pages(); track page.id) {
            <li (click)="selectPage(page.id)"
                class="group flex items-center justify-between p-2 rounded-md cursor-pointer text-sm"
                [class]="page.id === activePageId() ? 'bg-slate-700 font-semibold' : 'hover:bg-slate-700/50'">
              
              @if (editingPageId() === page.id) {
                <input type="text" #pageNameInput [value]="page.name"
                       class="w-full bg-slate-600 text-white rounded px-1 -ml-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                       (blur)="finishEditingPageName(page, $event.target.value)"
                       (keydown.enter)="finishEditingPageName(page, $event.target.value)"
                       (click)="$event.stopPropagation()">
              } @else {
                <span class="truncate">{{ page.name }}</span>
                <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <button (click)="startEditingPageName(page.id, $event)" class="p-1 hover:bg-slate-600 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                  </button>
                  <button (click)="deletePage(page.id, $event)" class="p-1 hover:bg-slate-600 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3.5 h-3.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  </button>
                </div>
              }
            </li>
          }
        </ul>
        <button (click)="addPage()" class="w-full mt-2 px-3 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-md flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Add Page
        </button>
      </aside>
    }

    <div class="flex flex-col flex-1 overflow-hidden">
      <!-- Top Bar -->
      <div class="p-4 border-b border-slate-200 flex items-center gap-3 bg-slate-50/50">
        @if (!isPreviewMode()) {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-slate-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" placeholder="Find components..." class="w-full bg-transparent focus:outline-none text-slate-600 placeholder-slate-400"/>
          @if (selectedWidgetIds().size > 1) {
            <button (click)="groupSelection()" class="ml-auto flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border border-slate-300 bg-white hover:bg-slate-50 text-slate-600">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
              <span>Group</span>
            </button>
          }
        } @else {
          <p class="font-semibold text-slate-700">{{ activePage()?.name }}</p>
        }
        <button (click)="togglePreviewMode()" class="ml-auto flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border border-slate-300 bg-white hover:bg-slate-50 text-slate-600">
          @if(isPreviewMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            <span>Edit</span>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span>Preview</span>
          }
        </button>
      </div>

      <div class="flex flex-1 overflow-hidden">
        <!-- Left Panel: Component List -->
        @if (!isPreviewMode()) {
          <aside class="p-4 border-r border-slate-200 overflow-y-auto bg-slate-50/50 transition-all duration-300 ease-in-out" 
                 [class.w-1/3]="!isComponentListCollapsed()"
                 [class.max-w-xs]="!isComponentListCollapsed()"
                 [class.w-20]="isComponentListCollapsed()">
            <div class="flex items-center justify-between mb-3" [class.flex-col]="isComponentListCollapsed()" [class.gap-2]="isComponentListCollapsed()">
                <h2 class="text-sm font-semibold text-slate-500 px-2" [class.hidden]="isComponentListCollapsed()">Components</h2>
                <button (click)="toggleComponentList()" class="p-2 rounded-md hover:bg-slate-200/50 text-slate-500">
                    @if(isComponentListCollapsed()) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    }
                </button>
            </div>
            <ul class="space-y-1">
              @for (widget of filteredWidgets(); track widget.type) {
                <li (click)="selectWidget(widget.type)" class="flex items-start gap-4 p-3 rounded-lg cursor-pointer transition-colors duration-200" 
                    [class.flex-col]="isComponentListCollapsed()" 
                    [class.items-center]="isComponentListCollapsed()" 
                    [class.gap-2]="isComponentListCollapsed()"
                    [class]="widget.type === selectedWidgetType() && !isComponentListCollapsed() ? 'bg-blue-500 text-white' : 'hover:bg-slate-200 text-slate-700'">
                  <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-lg" [class]="widget.type === selectedWidgetType() && !isComponentListCollapsed() ? 'bg-blue-600' : 'bg-amber-400 text-amber-900'">
                    <div [innerHTML]="widget.icon | safeHtml"></div>
                  </div>
                   @if(!isComponentListCollapsed()) {
                    <div>
                      <p class="font-semibold">{{ widget.name }}</p>
                      <p class="text-sm" [class]="widget.type === selectedWidgetType() ? 'text-blue-100' : 'text-slate-500'">{{ widget.description }}</p>
                    </div>
                   } @else {
                     <p class="text-xs text-center truncate w-full" [class]="widget.type === selectedWidgetType() ? 'font-bold text-blue-600' : 'text-slate-600'">{{ widget.name }}</p>
                   }
                </li>
              }
            </ul>
          </aside>
        }

        <!-- Right Panel: Dashboard Canvas -->
        <main class="flex-1 p-6 sm:p-8 lg:p-12 overflow-auto bg-slate-100 relative" (click)="clearSelection()" (contextmenu)="onCanvasContextMenu($event)">
          @if (dashboardWidgets().length === 0) {
            <div class="flex items-center justify-center h-full">
              <div class="text-center text-slate-400">
                <p class="text-lg font-medium">{{ activePage()?.name || 'Canvas' }}</p>
                <p class="text-sm">Right-click to add a component, or select one from the left panel.</p>
              </div>
            </div>
          } @else {
            <div class="w-full h-full">
              @for(widget of dashboardWidgets(); track widget.id) {
                <app-dynamic-host 
                  [instance]="widget" 
                  [isPreviewMode]="isPreviewMode()" 
                  [isSelected]="selectedWidgetIds().has(widget.id)"
                  (remove)="removeWidget($event)" 
                  (edit)="openEditModal($event)" 
                  (widgetChange)="updateWidget($event)"
                  (selectWidget)="toggleWidgetSelection($event)"
                  (ungroup)="ungroupWidget($event)"></app-dynamic-host>
              }
            </div>
          }
        </main>
      </div>
    </div>
  </div>
</div>

@if (editingWidget()) {
  <app-edit-modal [widget]="editingWidget()!" (save)="saveWidgetChanges($event)" (close)="closeEditModal()"></app-edit-modal>
}

<!-- Canvas Context Menu -->
@if (canvasContextMenu(); as cm) {
  <div class="fixed bg-white rounded-md shadow-lg border border-slate-200 py-1 z-50 text-sm"
       [style.left.px]="cm.x"
       [style.top.px]="cm.y">
    <ul>
      <li class="px-4 py-1.5 hover:bg-slate-100 cursor-default relative group">
        <div class="flex items-center justify-between">
          <span>Add Component</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </div>
        <!-- Submenu -->
        <div class="absolute left-full -top-1 ml-1 hidden group-hover:block bg-white rounded-md shadow-lg border border-slate-200 py-1 w-52 max-h-60 overflow-y-auto">
          <ul>
            @for(widget of availableWidgets(); track widget.type) {
              <li (click)="addWidget(widget.type, { x: cm.canvasX, y: cm.canvasY })" class="px-3 py-2 hover:bg-slate-100 cursor-pointer flex items-center gap-3">
                 <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-amber-400 text-amber-900">
                    <div [innerHTML]="widget.icon | safeHtml"></div>
                  </div>
                 <span>{{ widget.name }}</span>
              </li>
            }
          </ul>
        </div>
      </li>
      <li class="px-4 py-1.5 text-slate-400 cursor-not-allowed">Page Settings</li>
    </ul>
  </div>
}
